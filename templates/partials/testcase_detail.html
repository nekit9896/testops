{# 
  Partial template для детальной панели тест-кейса.
  Используется для AJAX-загрузки без перезагрузки всей страницы.
  
  Ожидаемые переменные:
    - create: bool - режим создания
    - selected_case: TestCase object - выбранный тест-кейс для редактирования
#}

{% if create %}
  <!-- CREATE form -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4">
        {% for category, msg in messages %}
          <div class="p-3 rounded {{ 'bg-red-100 text-red-800' if category == 'error' else 'bg-green-100 text-green-800' }}">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  <h3 class="text-xl font-semibold mb-3">Создать тест-кейс</h3>

  <form id="create-case-form" action="{{ url_for('routes.create_test_case') }}" method="post">
    <div class="mb-3">
      <label class="block font-medium">Название</label>
      <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
    </div>

    <div class="mb-3">
      <label class="block font-medium">Tags (через запятую)</label>
      <input type="text" name="tags" class="w-full border rounded px-3 py-2" placeholder="regression, smoke">
    </div>

    <div class="mb-3">
      <label class="block font-medium">Suites (через запятую)</label>
      <input type="text" name="suite_links" class="w-full border rounded px-3 py-2" placeholder="Suite A, Suite B">
    </div>

    <div class="mb-3">
      <label class="block font-medium">Предусловие</label>
      <textarea name="preconditions" class="w-full border rounded px-3 py-2" rows="3"></textarea>
    </div>

    <div class="mb-3">
      <label class="block font-medium">Описание</label>
      <textarea name="description" class="w-full border rounded px-3 py-2" rows="4"></textarea>
    </div>

    <div class="mb-6">
      <label class="block font-medium mb-2">Шаги</label>
      <div id="steps-create" class="space-y-1" data-steps-create></div>
      <div class="mt-2">
        <button type="button" class="px-2 py-1 text-green-600 border border-green-200 rounded hover:bg-green-50" data-add-step-create>+ Шаг</button>
      </div>
    </div>

    <div class="mb-3 mt-4">
      <label class="block font-medium">Ожидаемый результат</label>
      <textarea name="expected_result" class="w-full border rounded px-3 py-2" rows="2"></textarea>
    </div>

    <div class="flex justify-end gap-2 mt-4">
      <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Создать</button>
    </div>
  </form>

{% elif selected_case %}
  <!-- EDIT / VIEW -->

  <form id="edit-case-form"
        data-testcase-id="{{ selected_case.id }}"
        data-api-url="{{ url_for('routes.update_test_case', test_case_id=selected_case.id) }}"
        action="#"
        method="post">

    <div class="mb-3 flex items-center gap-3">
      <div class="text-sm text-gray-500 flex-none">ID {{ selected_case.id }}</div>
      <input type="text" name="name" value="{{ selected_case.name }}" class="flex-1 border rounded px-3 py-2 text-lg font-bold" required>
    </div>

    <div class="mb-3 flex space-x-4">
      <!-- Tags -->
      <div class="flex-1 min-w-0">
        <label class="block font-medium text-sm mb-1">Tags</label>
        <textarea name="tags"
                  rows="1"
                  class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                  placeholder="regression, smoke">{% for tt in selected_case.tags %}{% if tt.name is defined %}{{ tt.name }}{% else %}{{ tt }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
      </div>

      <!-- Suites -->
      <div class="flex-1 min-w-0">
        <label class="block font-medium text-sm mb-1">Suites</label>
        <textarea name="suites"
                  rows="1"
                  class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                  placeholder="Suite A, Suite B"
                  >{% for ss in selected_case.suites %}{% if ss.name is defined %}{{ ss.name }}{% else %}{{ ss }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
      </div>
    </div>

    <div class="mb-3">
      <label class="block font-medium">Предусловие</label>

      {% set txt = selected_case.preconditions | default('') %}
      {% set total = txt | length %}
      {% set nlines = txt.splitlines() | length %}
      {% set chars_per_row = 80 %}
      {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
      {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
      {% set rows = [ rows_calc, 15 ] | min %}

      <textarea
        name="preconditions"
        class="w-full border rounded px-3 py-2"
        rows="{{ rows }}"
        style="resize:vertical; overflow:auto;"
      >{{ selected_case.preconditions }}</textarea>
    </div>


    <div class="mb-3">
      <label class="block font-medium">Описание</label>

      {% set txt = selected_case.description | default('') %}
      {% set total = txt | length %}
      {% set nlines = txt.splitlines() | length %}
      {% set chars_per_row = 100 %}
      {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
      {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
      {% set rows = [ rows_calc, 40 ] | min %}

      <textarea
        name="description"
        class="w-full border rounded px-3 py-2"
        rows="{{ rows }}"
        style="resize:vertical; overflow:auto;"
      >{{ selected_case.description }}</textarea>
    </div>

    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-semibold">Шаги</h4>
        <button type="button" id="btn-add-step-top" class="px-3 py-1 text-green-600 border border-green-200 rounded hover:bg-green-50 hidden">+ Шаг</button>
      </div>
      <div id="steps-edit" class="space-y-1" data-steps-edit>
        {% for s in selected_case.steps %}
          <div class="py-1" data-step-row>
            <div class="flex gap-2 items-center">

              <div class="w-8 text-sm text-gray-600 flex-none">#{{ s.position if s.position is not none else loop.index }}</div>

              {% set act_txt = (s.action | default('')) %}
              {% set act_total = act_txt | length %}
              {% set act_nlines = act_txt.splitlines() | length %}
              {% set act_chars_per_row = 80 %}
              {% set act_est = ((act_total + act_chars_per_row - 1) // act_chars_per_row) %}
              {% set act_rows_calc = [ (act_nlines if act_nlines > 0 else 1), act_est ] | max %}
              {% set act_rows = [ act_rows_calc, 10 ] | min %}

              <textarea placeholder="Action"
                        class="flex-1 border rounded text-sm px-2 py-1"
                        rows="{{ act_rows }}" data-step-action>{{ s.action }}</textarea>

              {% set exp_txt = (s.expected | default('')) %}
              {% set exp_total = exp_txt | length %}
              {% set exp_nlines = exp_txt.splitlines() | length %}
              {% set exp_chars_per_row = 80 %}
              {% set exp_est = ((exp_total + exp_chars_per_row - 1) // exp_chars_per_row) %}
              {% set exp_rows_calc = [ (exp_nlines if exp_nlines > 0 else 1), exp_est ] | max %}
              {% set exp_rows = [ exp_rows_calc, 10 ] | min %}

              <textarea placeholder="Expected"
                        class="flex-1 border rounded text-sm px-2 py-1"
                        rows="{{ exp_rows }}" data-step-expected>{{ s.expected }}</textarea>

              <button type="button" class="px-3 py-1 text-green-600 border border-green-200 rounded btn-insert-step hover:bg-green-50 font-bold" data-insert-index="{{ loop.index0 }}">+</button>
              <button type="button" class="px-3 py-1 text-red-600 border border-red-200 rounded btn-delete-step hover:bg-red-50 font-bold" data-delete-index="{{ loop.index0 }}">−</button>

            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mb-3 mt-4">
        <label class="block font-medium">Ожидаемый результат</label>

        {% set txt = selected_case.expected_result | default('') %}
        {% set total = txt | length %}
        {% set nlines = txt.splitlines() | length %}
        {% set chars_per_row = 100 %}
        {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
        {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
        {% set rows = [ rows_calc, 40 ] | min %}

        <textarea
          name="expected_result"
          class="w-full border rounded px-3 py-2"
          rows="{{ rows }}"
          style="resize:vertical; overflow:auto;"
        >{{ selected_case.expected_result }}</textarea>
      </div>
    </div>

    <!-- Дополнительная информация -->
    <div class="mb-3">
      <div class="text-xs text-gray-500">
        Created: {% if selected_case.created_at %}{{ selected_case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}
        {% if selected_case.updated_at %}
          <br>Updated: {{ selected_case.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
        {% endif %}
      </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Сохранить изменения</button>
      <button
        type="button"
        class="px-3 py-1 text-red-600 border border-red-200 rounded hover:bg-red-50"
        data-delete-case="{{ selected_case.id }}"
        data-confirm="Удалить тест-кейс?">Удалить тест-кейс</button>
    </div>
  </form>

  <!-- === Вложения === -->
  <div class="mt-6 mb-4">
    <div class="flex items-center justify-between mb-2">
      <h4 class="font-semibold">Вложения</h4>
      <button type="button" 
              id="btn-attach-file"
              data-upload-url="{{ url_for('routes.upload_test_case_attachment', test_case_id=selected_case.id) }}"
              class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
        </svg>
        Прикрепить файл
      </button>
      <input type="file" id="hidden-file-input" class="hidden" />
    </div>

    <div id="attachments-list" class="space-y-2">
      {% for a in selected_case.attachments %}
        <div class="flex items-center justify-between border rounded p-2">
          <div>
            <div class="font-medium">{{ a.original_filename }}</div>
            <div class="text-xs text-gray-500">{{ a.size }} bytes • {{ a.content_type }}</div>
          </div>
          <div class="flex items-center gap-2">
            <a href="{{ url_for('routes.get_test_case_attachment', test_case_id=selected_case.id, attachment_id=a.id) }}?download=1"
               class="px-2 py-1 bg-blue-500 text-white rounded text-xs"
               target="_blank" rel="noopener noreferrer">Download</a>

            <button type="button"
                    class="px-2 py-1 bg-red-500 text-white rounded text-xs"
                    data-delete-attachment="{{ a.id }}"
                    data-testcase-id="{{ selected_case.id }}"
                    data-confirm="Удалить вложение?">Delete</button>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

{% else %}
  <div class="text-gray-500">Выберите тест-кейс из списка или создайте новый.</div>
{% endif %}

