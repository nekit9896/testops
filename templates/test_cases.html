{% extends 'base.html' %}

{% block head %}
  <title>Тест-кейсы</title>
{% endblock %}

{% block main_container_class %}w-full px-0 py-6{% endblock %}

{% block main %}
<main id="testcases-root"
      class="min-h-[72vh] w-full px-4"
      data-all-tags='{{ all_tags|map(attribute="name")|list|tojson if all_tags is defined else "[]" }}'
      data-selected-tags='{{ selected_tags|default(request.args.get("tags",""))|tojson }}'>
  <div class="w-full">

    <!-- Контейнер: три колонки в одной строке -->
    <div class="flex gap-6">

      <!-- LEFT: Suites — примерно 1/6 на экранах -->
      <aside class="w-full lg:w-1/6 bg-white border rounded p-3 shadow-sm overflow-auto lg:min-w-0 min-w-[200px]">
        <h3 class="text-lg font-semibold mb-1">Suites</h3>
        <div class="text-xs text-gray-500 mb-3">Создаётся вместе с тест-кейсом</div>

        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="mb-3">
          <input
            name="suite_name"
            value="{{ request.args.get('suite_name','') }}"
            type="search"
            placeholder="Поиск сьютов..."
            class="w-full px-2 py-1 border rounded bg-gray-50 text-xs focus:outline-none"
          />
          <button type="submit" class="mt-2 w-full px-2 py-1 bg-blue-500 text-xs text-white rounded">Найти</button>
        </form>

        <nav>
          <ul class="space-y-1 text-xs">
            <li>
              <a href="{{ url_for('routes.test_cases_page') }}"
                 class="block px-2 py-1 rounded {% if not request.args.get('suite_id') %}bg-blue-50 text-sm text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                Все сьюты
              </a>
            </li>

            {% if suites %}
              {% for s in suites %}
                <li>
                  <a href="{{ url_for('routes.test_cases_page') }}?suite_id={{ s.id }}{{ ('&suite_name=' ~ request.args.get('suite_name')) if request.args.get('suite_name') else '' }}"
                     class="block px-2 py-1 rounded {% if request.args.get('suite_id') == s.id|string %}bg-blue-50 text-sm text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                    {{ s.name }}
                  </a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </nav>
      </aside>

      <!-- MIDDLE: Test Cases list — от Suites до центра (примерно 1/3) -->
      <section class="w-full lg:w-1/3 bg-white border rounded p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Test Cases</h2>
          <a href="#" id="btn-create-testcase" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Создать тест-кейс</a>
        </div>

        <!-- ==== Форма поиска/фильтров ==== -->
        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="flex flex-wrap items-center gap-2 mb-3">
          <input name="q" value="{{ request.args.get('q','') }}" type="search"
                 placeholder="Поиск по названию..."
                 class="px-3 py-1 border rounded bg-gray-50 text-sm flex-1" />

          <!-- TAGS FILTER START -->
          <div class="relative" id="tags-filter-root">
            <button type="button" id="tags-toggle" class="px-3 py-1 border rounded bg-white text-sm flex items-center gap-2">
              <span id="tags-summary">Теги</span>
              <svg class="w-3 h-3 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21L10 11.98l4.77-4.77 1.41 1.41L10 14.8 3.82 8.62z"/></svg>
            </button>

            <div id="tags-dropdown" class="absolute right-0 mt-2 w-72 max-h-64 overflow-auto bg-white border rounded shadow-lg p-2 hidden z-50">
              <div class="flex gap-2 mb-2">
                <input id="tags-search" type="search" placeholder="Поиск тегов..." class="w-full px-2 py-1 border rounded text-sm" />
                <button type="button" id="tags-clear" class="w-24 px-2 py-1 bg-gray-200 rounded text-sm">Сбросить</button>
              </div>

              <div id="tags-list" class="text-sm space-y-1">
                {% if all_tags is defined and all_tags %}
                  <div class="text-xs text-gray-500">Загрузка...</div>
                {% else %}
                  <div class="text-xs text-gray-500">Теги не предоставлены сервером</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- скрытый инпут для передачи выбранных тегов (CSV) -->
          <input type="hidden" name="tags" id="tags-hidden" value="{{ selected_tags | default(request.args.get('tags','')) }}">
          <!-- TAGS FILTER END -->

          <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Найти</button>

          <div class="flex items-center gap-2 w-full">
            <label class="flex items-center gap-1 text-sm">
              <input type="checkbox" name="include_deleted" value="1" data-auto-submit-filter {% if request.args.get('include_deleted') %}checked{% endif %}>
              <span class="text-sm text-gray-600">include_deleted</span>
            </label>
            <select name="sort" class="px-2 py-1 border rounded bg-white text-sm" data-auto-submit-filter>
              <option value="-created_at" {% if request.args.get('sort','-created_at') == '-created_at' %}selected{% endif %}>Сначала новые</option>
              <option value="created_at" {% if request.args.get('sort') == 'created_at' %}selected{% endif %}>Сначала старые</option>
            </select>
          </div>
        </form>
        <!-- ==== /Форма поиска ==== -->

        <!-- Список тест-кейсов -->
        <div class="flex-1 overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-gray-600 border-b">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Название</th>
                <th class="p-2 text-left">Tags</th>
              </tr>
            </thead>
            <tbody id="cases-tbody">
              {% for tc in cases %}
                <tr class="border-t hover:bg-gray-50 testcase-row{% if selected_case and selected_case.id == tc.id %} bg-blue-50{% endif %}" data-testcase-id="{{ tc.id }}">
                  <td class="p-2">{{ tc.id }}</td>
                  <td class="p-2">
                    <a href="#" class="text-blue-600 hover:underline testcase-link" data-testcase-id="{{ tc.id }}">
                      {{ tc.name }}
                    </a>
                  </td>
                  <td class="p-2">
                    {% if tc.tags %}
                      {% for t in tc.tags %}
                        {% if t.name is defined %}
                          <a href="{{ url_for('routes.test_cases_page') }}?tags={{ t.name|urlencode }}" class="inline-block">
                            <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t.name }}</span>
                          </a>
                        {% else %}
                          <a href="{{ url_for('routes.test_cases_page') }}?tags={{ t|urlencode }}" class="inline-block">
                            <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t }}</span>
                          </a>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Пагинация -->
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600" id="pagination">
          <div>
            {% if meta.prev_cursor %}
              <a id="prev-link" href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.prev_cursor }}" class="px-2 py-1 border rounded hidden">Prev</a>
            {% endif %}
            {% if meta.next_cursor %}
              <a id="next-link" href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.next_cursor }}" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 cursor-pointer">Загрузить ещё</a>
            {% endif %}
          </div>
          <div id="meta-count">{{ meta.count if meta and meta.count else '' }}</div>
        </div>
      </section>

      <!-- RIGHT — занимает половину экрана -->
      <aside id="testcase-detail-panel" class="w-full lg:w-1/2 bg-white border rounded p-4 shadow-sm overflow-auto">
        {% include 'partials/testcase_detail.html' %}
      </aside>

    </div>
  </div>

  <!-- JS модули для страницы тест-кейсов -->
  <script defer src="{{ url_for('static', filename='js/common/namespace.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/common/toast.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/common/api.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/common/utils.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/steps.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/forms.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/attachments.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/filters.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/detail.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/pagination.js') }}"></script>
  <script defer src="{{ url_for('static', filename='js/testcases/init.js') }}"></script>
</main>
{% endblock %}
