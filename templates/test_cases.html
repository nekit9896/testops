{% extends 'base.html' %}

{% block head %}
  <title>Тест-кейсы</title>
{% endblock %}

{% block main_container_class %}w-full px-0 py-6{% endblock %}

{% block main %}
<main id="testcases-root"
      class="min-h-[72vh] w-full px-4"
      data-all-tags='{{ all_tags|map(attribute="name")|list|tojson if all_tags is defined else "[]" }}'
      data-selected-tags='{{ selected_tags|default(request.args.get("tags",""))|tojson }}'>
  <div class="w-full">

    <!-- Контейнер: три колонки в одной строке -->
    <div class="flex gap-6">

      <!-- LEFT: Suites — примерно 1/6 на экранах -->
      <aside class="w-full lg:w-1/6 bg-white border rounded p-3 shadow-sm overflow-auto lg:min-w-0 min-w-[200px]">
        <h3 class="text-lg font-semibold mb-1">Suites</h3>
        <div class="text-xs text-gray-500 mb-3">Создаётся вместе с тест-кейсом</div>

        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="mb-3">
          <input
            name="suite_name"
            value="{{ request.args.get('suite_name','') }}"
            type="search"
            placeholder="Поиск сьютов..."
            class="w-full px-2 py-1 border rounded bg-gray-50 text-xs focus:outline-none"
          />
          <button type="submit" class="mt-2 w-full px-2 py-1 bg-blue-500 text-xs text-white rounded">Найти</button>
        </form>

        <nav>
          <ul class="space-y-1 text-xs">
            <li>
              <a href="{{ url_for('routes.test_cases_page') }}"
                 class="block px-2 py-1 rounded {% if not request.args.get('suite_id') %}bg-blue-50 text-sm text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                Все сьюты
              </a>
            </li>

            {% if suites %}
              {% for s in suites %}
                <li>
                  <a href="{{ url_for('routes.test_cases_page') }}?suite_id={{ s.id }}{{ ('&suite_name=' ~ request.args.get('suite_name')) if request.args.get('suite_name') else '' }}"
                     class="block px-2 py-1 rounded {% if request.args.get('suite_id') == s.id|string %}bg-blue-50 text-sm text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                    {{ s.name }}
                  </a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </nav>
      </aside>

      <!-- MIDDLE: Test Cases list — от Suites до центра (примерно 1/3) -->
      <section class="w-full lg:w-1/3 bg-white border rounded p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Test Cases</h2>
          <a href="{{ url_for('routes.test_cases_page', create='1') }}" class="px-3 py-1 bg-green-500 text-white rounded">Создать тест-кейс</a>
        </div>

        <!-- ==== Форма поиска/фильтров ==== -->
        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="flex flex-wrap items-center gap-2 mb-3">
          <input name="q" value="{{ request.args.get('q','') }}" type="search"
                 placeholder="Поиск по названию..."
                 class="px-3 py-1 border rounded bg-gray-50 text-sm flex-1" />

          <!-- TAGS FILTER START -->
          <div class="relative" id="tags-filter-root">
            <button type="button" id="tags-toggle" class="px-3 py-1 border rounded bg-white text-sm flex items-center gap-2">
              <span id="tags-summary">Теги</span>
              <svg class="w-3 h-3 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21L10 11.98l4.77-4.77 1.41 1.41L10 14.8 3.82 8.62z"/></svg>
            </button>

            <div id="tags-dropdown" class="absolute right-0 mt-2 w-72 max-h-64 overflow-auto bg-white border rounded shadow-lg p-2 hidden z-50">
              <div class="flex gap-2 mb-2">
                <input id="tags-search" type="search" placeholder="Поиск тегов..." class="w-full px-2 py-1 border rounded text-sm" />
                <button type="button" id="tags-clear" class="w-24 px-2 py-1 bg-gray-200 rounded text-sm">Сбросить</button>
              </div>

              <div id="tags-list" class="text-sm space-y-1">
                {% if all_tags is defined and all_tags %}
                  <div class="text-xs text-gray-500">Загрузка...</div>
                {% else %}
                  <div class="text-xs text-gray-500">Теги не предоставлены сервером</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- скрытый инпут для передачи выбранных тегов (CSV) -->
          <input type="hidden" name="tags" id="tags-hidden" value="{{ selected_tags | default(request.args.get('tags','')) }}">
          <!-- TAGS FILTER END -->

          <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Найти</button>

          <div class="flex items-center gap-2 w-full">
            <label class="flex items-center gap-1 text-sm">
              <input type="checkbox" name="include_deleted" value="1" data-auto-submit-filter {% if request.args.get('include_deleted') %}checked{% endif %}>
              <span class="text-sm text-gray-600">include_deleted</span>
            </label>
            <select name="sort" class="px-2 py-1 border rounded bg-white text-sm" data-auto-submit-filter>
              <option value="-created_at" {% if request.args.get('sort','-created_at') == '-created_at' %}selected{% endif %}>Сначала новые</option>
              <option value="created_at" {% if request.args.get('sort') == 'created_at' %}selected{% endif %}>Сначала старые</option>
            </select>
          </div>
        </form>
        <!-- ==== /Форма поиска ==== -->

        <!-- Список тест-кейсов -->
        <div class="flex-1 overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-gray-600 border-b">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Название</th>
                <th class="p-2 text-left">Tags</th>
              </tr>
            </thead>
            <tbody id="cases-tbody">
              {% for tc in cases %}
                <tr class="border-t hover:bg-gray-50">
                  <td class="p-2">{{ tc.id }}</td>
                  <td class="p-2">
                    <a href="{{ url_for('routes.test_cases_page', selected_id=tc.id) }}" class="text-blue-600 hover:underline">
                      {{ tc.name }}
                    </a>
                  </td>
                  <td class="p-2">
                    {% if tc.tags %}
                      {% for t in tc.tags %}
                        {% if t.name is defined %}
                          <a href="{{ url_for('routes.test_cases_page') }}?tags={{ t.name|urlencode }}" class="inline-block">
                            <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t.name }}</span>
                          </a>
                        {% else %}
                          <a href="{{ url_for('routes.test_cases_page') }}?tags={{ t|urlencode }}" class="inline-block">
                            <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t }}</span>
                          </a>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Пагинация -->
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600" id="pagination">
          <div>
            {% if meta.prev_cursor %}
              <a id="prev-link" href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.prev_cursor }}" class="px-2 py-1 border rounded">Prev</a>
            {% endif %}
            {% if meta.next_cursor %}
              <a id="next-link" href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.next_cursor }}" class="px-2 py-1 border rounded ml-2">Next</a>
            {% endif %}
          </div>
          <div id="meta-count">{{ meta.count if meta and meta.count else '' }}</div>
        </div>
      </section>

      <!-- RIGHT — занимает половину экрана -->
      <aside class="w-full lg:w-1/2 bg-white border rounded p-4 shadow-sm overflow-auto">
        {% if create %}
          <!-- CREATE form -->
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="mb-4">
                {% for category, msg in messages %}
                  <div class="p-3 rounded {{ 'bg-red-100 text-red-800' if category == 'error' else 'bg-green-100 text-green-800' }}">
                    {{ msg }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          <h3 class="text-xl font-semibold mb-3">Создать тест-кейс</h3>

          <form id="create-case-form" action="{{ url_for('routes.create_test_case') }}" method="post">
            <div class="mb-3">
              <label class="block font-medium">Название</label>
              <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Tags (через запятую)</label>
              <input type="text" name="tags" class="w-full border rounded px-3 py-2" placeholder="regression, smoke">
            </div>

            <div class="mb-3">
              <label class="block font-medium">Suites (через запятую)</label>
              <input type="text" name="suite_links" class="w-full border rounded px-3 py-2" placeholder="Suite A, Suite B">
            </div>

            <div class="mb-3">
              <label class="block font-medium">Предусловие</label>
              <textarea name="preconditions" class="w-full border rounded px-3 py-2" rows="3"></textarea>
            </div>

              <div class="mb-3">
              <label class="block font-medium">Описание</label>
              <textarea name="description" class="w-full border rounded px-3 py-2" rows="4"></textarea>
            </div>

            <div class="mb-6">
              <label class="block font-medium mb-2">Шаги</label>
              <div id="steps-create" class="space-y-2" data-steps-create></div>
              <div class="mt-2">
                <button type="button" class="px-2 py-1 text-green-600 border border-green-200 rounded hover:bg-green-50" data-add-step-create>+ Шаг</button>
              </div>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Ожидаемый результат</label>
              <textarea name="expected_result" class="w-full border rounded px-3 py-2" rows="2"></textarea>
            </div>

            <div class="flex justify-end gap-2 mt-4">
              <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Создать</button>
            </div>
          </form>

        {% elif selected_case %}
          <!-- EDIT / VIEW -->

          <form id="edit-case-form"
                data-testcase-id="{{ selected_case.id }}"
                data-api-url="{{ url_for('routes.update_test_case', test_case_id=selected_case.id) }}"
                action="#"
                method="post">

            <div class="mb-3 flex items-center gap-3">
              <div class="text-sm text-gray-500 flex-none">ID {{ selected_case.id }}</div>
              <input type="text" name="name" value="{{ selected_case.name }}" class="flex-1 border rounded px-3 py-2 text-lg font-bold" required>
            </div>

            <div class="mb-3 flex space-x-4">
              <!-- Tags -->
              <div class="flex-1 min-w-0">
                <label class="block font-medium text-sm mb-1">Tags</label>
                <textarea name="tags"
                          rows="1"
                          class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                          placeholder="regression, smoke">{% for tt in selected_case.tags %}{% if tt.name is defined %}{{ tt.name }}{% else %}{{ tt }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
              </div>

              <!-- Suites -->
              <div class="flex-1 min-w-0">
                <label class="block font-medium text-sm mb-1">Suites</label>
                <textarea name="suites"
                          rows="1"
                          class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                          placeholder="Suite A, Suite B"
                          >{% for ss in selected_case.suites %}{% if ss.name is defined %}{{ ss.name }}{% else %}{{ ss }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
              </div>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Предусловие</label>

              {% set txt = selected_case.preconditions | default('') %}
              {% set total = txt | length %}
              {% set nlines = txt.splitlines() | length %}
              {# меньшая ширина — используем меньше символов на строку #}
              {% set chars_per_row = 80 %}
              {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
              {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
              {% set rows = [ rows_calc, 15 ] | min %}

              <textarea
                name="preconditions"
                class="w-full border rounded px-3 py-2"
                rows="{{ rows }}"
                style="resize:vertical; overflow:auto;"
              >{{ selected_case.preconditions }}</textarea>
            </div>


            <div class="mb-3">
              <label class="block font-medium">Описание</label>

              {# --- server-side estimate of rows (approx visual wrapping) --- #}
              {% set txt = selected_case.description | default('') %}
              {% set total = txt | length %}
              {% set nlines = txt.splitlines() | length %}
              {# пример: 100 символов в строке — подберите под ваш макет (см. примечание) #}
              {% set chars_per_row = 100 %}
              {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
              {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
              {% set rows = [ rows_calc, 40 ] | min %}

              <textarea
                name="description"
                class="w-full border rounded px-3 py-2"
                rows="{{ rows }}"
                style="resize:vertical; overflow:auto;"
              >{{ selected_case.description }}</textarea>
            </div>

            <div class="mb-6">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold">Шаги</h4>
                <button type="button" id="btn-add-step-top" class="px-3 py-1 text-green-600 border border-green-200 rounded hover:bg-green-50 hidden">+ Шаг</button>
              </div>
              <div id="steps-edit" class="space-y-3" data-steps-edit>
                {% for s in selected_case.steps %}
                  <div class="p-2" data-step-row>
                    <div class="flex gap-2 items-start">

                      <div class="w-8 text-sm text-gray-600 pt-2 flex-none">#{{ s.position if s.position is not none else loop.index }}</div>

                      {# --- ACTION textarea autosize estimate --- #}
                      {% set act_txt = (s.action | default('')) %}
                      {% set act_total = act_txt | length %}
                      {% set act_nlines = act_txt.splitlines() | length %}
                      {% set act_chars_per_row = 80 %}
                      {% set act_est = ((act_total + act_chars_per_row - 1) // act_chars_per_row) %}
                      {% set act_rows_calc = [ (act_nlines if act_nlines > 0 else 1), act_est ] | max %}
                      {% set act_rows = [ act_rows_calc, 10 ] | min %}

                      <textarea placeholder="Action"
                                class="flex-1 border rounded text-sm px-2 py-1"
                                rows="{{ act_rows }}" data-step-action>{{ s.action }}</textarea>

                      {# --- EXPECTED textarea autosize estimate --- #}
                      {% set exp_txt = (s.expected | default('')) %}
                      {% set exp_total = exp_txt | length %}
                      {% set exp_nlines = exp_txt.splitlines() | length %}
                      {% set exp_chars_per_row = 80 %}
                      {% set exp_est = ((exp_total + exp_chars_per_row - 1) // exp_chars_per_row) %}
                      {% set exp_rows_calc = [ (exp_nlines if exp_nlines > 0 else 1), exp_est ] | max %}
                      {% set exp_rows = [ exp_rows_calc, 10 ] | min %}

                      <textarea placeholder="Expected"
                                class="flex-1 border rounded text-sm px-2 py-1"
                                rows="{{ exp_rows }}" data-step-expected>{{ s.expected }}</textarea>

                      {% if confirm_delete_step is defined and confirm_delete_step == loop.index0 %}
                        <div class="flex flex-col gap-1">
                          <div class="text-sm text-red-600">Подтвердите удаление шага #{{ loop.index }}</div>
                          <div class="flex gap-1">
                            <button type="submit" name="confirm_delete_step" value="{{ loop.index0 }}" class="px-2 py-1 bg-red-600 text-white rounded text-sm">Удалить</button>
                            <button type="submit" name="cancel_confirm" value="1" class="px-2 py-1 bg-gray-200 rounded text-sm">Отмена</button>
                          </div>
                        </div>
                      {% else %}
                        <button type="button" class="px-3 py-1 text-green-600 border border-green-200 rounded btn-insert-step hover:bg-green-50" data-insert-index="{{ loop.index0 }}">+</button>
                        <button type="button" class="px-3 py-1 text-red-600 border border-red-200 rounded btn-delete-step hover:bg-red-50" data-delete-index="{{ loop.index0 }}">−</button>
                      {% endif %}

                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="mb-3">
              <label class="block font-medium">Ожидаемый результат</label>

              {% set txt = selected_case.expected_result | default('') %}
              {% set total = txt | length %}
              {% set nlines = txt.splitlines() | length %}
              {% set chars_per_row = 100 %}
              {% set est = ((total + chars_per_row - 1) // chars_per_row) %}
              {% set rows_calc = [ (nlines if nlines > 0 else 1), est ] | max %}
              {% set rows = [ rows_calc, 40 ] | min %}

              <textarea
                name="expected_result"
                class="w-full border rounded px-3 py-2"
                rows="{{ rows }}"
                style="resize:vertical; overflow:auto;"
              >{{ selected_case.expected_result }}</textarea>
              </div>
            </div>

            <!-- Дополнительная информация -->
            <div class="mb-3">
              <div class="text-xs текст-gray-500">
                Created: {% if selected_case.created_at %}{{ selected_case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}
                {% if selected_case.updated_at %}
                  <br>Updated: {{ selected_case.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% endif %}
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between">
              <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Сохранить изменения</button>
              <button
                type="button"
                class="px-3 py-1 text-red-600 border border-red-200 rounded hover:bg-red-50"
                data-delete-case="{{ selected_case.id }}"
                data-confirm="Удалить тест-кейс?">Удалить тест-кейс</button>
            </div>
          </form>

          <!-- === Вложения — отдельный блок (вне формы update/create) чтобы upload не ломал update === -->
          <div class="mt-6 mb-4">
            <h4 class="font-semibold mb-2">Вложения</h4>

            <form id="upload-form" action="{{ url_for('routes.upload_test_case_attachment', test_case_id=selected_case.id) }}" method="post" enctype="multipart/form-data" class="mb-3">
              <input type="file" name="file" class="block w-full border px-2 py-1 rounded bg-white" />
              <div class="mt-2 flex gap-2">
                <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Загрузить вложение</button>
              </div>
            </form>

            <div class="space-y-2">
              {% for a in selected_case.attachments %}
                <div class="flex items-center justify-between border rounded p-2">
                  <div>
                    <div class="font-medium">{{ a.original_filename }}</div>
                    <div class="text-xs text-gray-500">{{ a.size }} bytes • {{ a.content_type }}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <a href="{{ url_for('routes.get_test_case_attachment', test_case_id=selected_case.id, attachment_id=a.id) }}?download=1"
                       class="px-2 py-1 bg-blue-500 text-white rounded text-xs"
                       target="_blank" rel="noopener noreferrer">Download</a>

                    <button type="button"
                            class="px-2 py-1 bg-red-500 text-white rounded text-xs"
                            data-delete-attachment="{{ a.id }}"
                            data-testcase-id="{{ selected_case.id }}"
                            data-confirm="Удалить вложение?">Delete</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <div class="text-gray-500">Выберите тест-кейс из списка или создайте новый.</div>
        {% endif %}
      </aside>

    </div>
  </div>

  <script defer src="{{ url_for('static', filename='js/test_cases.js') }}"></script>
</main>
{% endblock %}
