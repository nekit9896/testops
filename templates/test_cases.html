{% extends 'base.html' %}

{% block head %}
  <title>Тест-кейсы</title>
{% endblock %}

{% block main_container_class %}w-full px-0 py-6{% endblock %}

{% block main %}
<main class="min-h-[72vh] w-full px-4">
  <div class="w-full">

    <!-- Контейнер: три колонки в одной строке -->
    <div class="flex gap-6">

      <!-- LEFT: Suites — примерно 1/6 на экранах -->
      <aside class="w-full lg:w-1/6 bg-white border rounded p-3 shadow-sm overflow-auto lg:min-w-0 min-w-[200px]">
        <h3 class="text-lg font-semibold mb-1">Suites</h3>
        <div class="text-xs text-gray-500 mb-3">Создаётся вместе с тест-кейсом</div>

        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="mb-3">
          <input
            name="suite_name"
            value="{{ request.args.get('suite_name','') }}"
            type="search"
            placeholder="Поиск сьютов..."
            class="w-full px-2 py-1 border rounded bg-gray-50 text-xs focus:outline-none"
          />
          <button type="submit" class="mt-2 w-full px-2 py-1 bg-blue-500 text-xs text-white rounded">Найти</button>
        </form>

        <nav>
          <ul class="space-y-1 text-xs">
            <li>
              <a href="{{ url_for('routes.test_cases_page') }}"
                 class="block px-2 py-1 rounded {% if not request.args.get('suite_id') %}bg-blue-50 text-base text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                Все сьюты
              </a>
            </li>

            {% if suites %}
              {% for s in suites %}
                <li>
                  <a href="{{ url_for('routes.test_cases_page') }}?suite_id={{ s.id }}"
                     class="block px-2 py-1 rounded {% if request.args.get('suite_id') == s.id|string %}bg-blue-50 text-base text-blue-700{% else %}hover:bg-gray-100{% endif %}">
                    {{ s.name }}
                  </a>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </nav>
      </aside>

      <!-- MIDDLE: Test Cases list — от Suites до центра (примерно 1/3) -->
      <section class="w-full lg:w-1/3 bg-white border rounded p-4 shadow-sm flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Test Cases</h2>
          <a href="{{ url_for('routes.test_cases_page', create='1') }}" class="px-3 py-1 bg-green-500 text-white rounded">Создать тест-кейс</a>
        </div>

        <form method="get" action="{{ url_for('routes.test_cases_page') }}" class="flex flex-wrap items-center gap-2 mb-3">
          <input name="q" value="{{ request.args.get('q','') }}" type="search"
                 placeholder="Поиск по названию..."
                 class="px-3 py-1 border rounded bg-gray-50 text-sm flex-1" />
          <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Найти</button>

          <div class="flex items-center gap-2 w-full">
            <label class="flex items-center gap-1 text-sm">
              <input type="checkbox" name="include_deleted" value="1" {% if request.args.get('include_deleted') %}checked{% endif %}>
              <span class="text-sm text-gray-600">include_deleted</span>
            </label>
            <select name="sort" class="px-2 py-1 border rounded bg-white text-sm">
              <option value="-created_at" {% if request.args.get('sort','-created_at') == '-created_at' %}selected{% endif %}>Сначала новые</option>
              <option value="created_at" {% if request.args.get('sort') == 'created_at' %}selected{% endif %}>Сначала старые</option>
            </select>
          </div>
        </form>

        <!-- Список тест-кейсов -->
        <div class="flex-1 overflow-auto">
          <table class="w-full text-sm">
            <thead class="text-gray-600 border-b">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Название</th>
                <th class="p-2 text-left">Tags</th>
              </tr>
            </thead>
            <tbody>
              {% for tc in cases %}
                <tr class="border-t hover:bg-gray-50">
                  <td class="p-2">{{ tc.id }}</td>
                  <td class="p-2">
                    <a href="{{ url_for('routes.test_cases_page', selected_id=tc.id) }}" class="text-blue-600 hover:underline">
                      {{ tc.name }}
                    </a>
                  </td>
                  <td class="p-2">
                    {% if tc.tags %}
                      {% for t in tc.tags %}
                        {% if t.name is defined %}
                          <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t.name }}</span>
                        {% else %}
                          <span class="inline-block bg-indigo-100 text-indigo-800 rounded px-2 py-0.5 mr-1 text-xs">{{ t }}</span>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Пагинация -->
        <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
          <div>
            {% if meta.prev_cursor %}
              <a href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.prev_cursor }}" class="px-2 py-1 border rounded">Prev</a>
            {% endif %}
            {% if meta.next_cursor %}
              <a href="{{ url_for('routes.test_cases_page') }}?cursor={{ meta.next_cursor }}" class="px-2 py-1 border rounded ml-2">Next</a>
            {% endif %}
          </div>
          <div>{{ meta.count if meta and meta.count else '' }}</div>
        </div>
      </section>

      <!-- RIGHT — занимает половину экрана -->
      <aside class="w-full lg:w-1/2 bg-white border rounded p-4 shadow-sm overflow-auto">
        {% if create %}
          <!-- CREATE form -->
          <h3 class="text-xl font-semibold mb-3">Создать тест-кейс</h3>

          <form method="post" action="{{ url_for('routes.create_test_case') }}">
            <div class="mb-3">
              <label class="block font-medium">Название</label>
              <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Tags (через запятую)</label>
              <input type="text" name="tags" class="w-full border rounded px-3 py-2" placeholder="regression, smoke">
            </div>

            <div class="mb-3">
              <label class="block font-medium">Suites (через запятую)</label>
              <input type="text" name="suite_links" class="w-full border rounded px-3 py-2" placeholder="Suite A, Suite B">
            </div>

            <div class="mb-3">
              <label class="block font-medium">Предусловие</label>
              <textarea name="preconditions" class="w-full border rounded px-3 py-2" rows="1"></textarea>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Описание</label>
              <textarea name="description" class="w-full border rounded px-3 py-2" rows="2"></textarea>
            </div>

            <div class="mb-3">
              <label class="block font-medium mb-2">Шаги</label>
              <div id="steps-create" class="space-y-2">
                <div class="flex gap-2 items-start">
                  <div class="text-sm text-gray-600 pt-2">#1</div>
                  <input type="text" name="steps[0][action]" placeholder="Action" class="flex-1 border rounded px-2 py-1">
                  <input type="text" name="steps[0][expected]" placeholder="Expected" class="flex-1 border rounded px-2 py-1">
                </div>
              </div>
              <div class="mt-2">
                <button type="button" onclick="addCreateStep()" class="px-2 py-1 bg-green-500 text-white rounded">+ Шаг</button>
              </div>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Ожидаемый результат</label>
              <textarea name="expected_result" class="w-full border rounded px-3 py-2" rows="2"></textarea>
            </div>

            <div class="flex justify-end gap-2 mt-4">
              <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Создать</button>
            </div>
          </form>

          <script>
            (function(){
              let idx = 1;
              window.addCreateStep = function(){
                const container = document.getElementById('steps-create');
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-start';
                div.innerHTML = `<div class="text-sm text-gray-600 pt-2">#${idx+1}</div>
                  <input type="text" name="steps[${idx}][action]" placeholder="Action" class="flex-1 border rounded px-2 py-1">
                  <input type="text" name="steps[${idx}][expected]" placeholder="Expected" class="flex-1 border rounded px-2 py-1">
                  <button type="button" onclick="this.parentElement.remove()" class="px-2 py-1 bg-red-500 text-white rounded">−</button>`;
                container.appendChild(div);
                idx++;
              };
            })();
          </script>

        {% elif selected_case %}
          <!-- EDIT / VIEW -->

          <form method="post" action="{{ url_for('routes.update_test_case', test_case_id=selected_case.id) }}">
            <input type="hidden" name="_method" value="PUT">

            <div class="mb-2">
              <div class="text-sm text-gray-500">ID {{ selected_case.id }}</div>
            </div>

            <div class="mb-3">
              <input type="text" name="name" value="{{ selected_case.name }}" class="w-full border rounded px-4 py-3 text-lg font-bold" required>
            </div>

            <div class="mb-3 flex space-x-4">
              <!-- Tags -->
              <div class="flex-1 min-w-0">
                <label class="block font-medium text-sm mb-1">Tags</label>
                <textarea name="tags"
                          rows="1"
                          class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                          placeholder="regression, smoke"
                          oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">{% for tt in selected_case.tags %}{% if tt.name is defined %}{{ tt.name }}{% else %}{{ tt }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
              </div>

              <!-- Suites -->
              <div class="flex-1 min-w-0">
                <label class="block font-medium text-sm mb-1">Suites</label>
                <textarea name="suites"
                          rows="1"
                          class="w-full border rounded px-2 py-1 text-sm resize-y overflow-auto break-words"
                          placeholder="Suite A, Suite B"
                          oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';">{% for ss in selected_case.suites %}{% if ss.name is defined %}{{ ss.name }}{% else %}{{ ss }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}</textarea>
              </div>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Предусловие</label>
              <textarea name="preconditions" class="w-full border rounded px-3 py-2" rows="1">{{ selected_case.preconditions }}</textarea>
            </div>

            <div class="mb-3">
              <label class="block font-medium">Описание</label>
              <textarea name="description" class="w-full border rounded px-3 py-2" rows="2">{{ selected_case.description }}</textarea>
            </div>

            <div class="mb-3">
              <h4 class="font-semibold mb-2">Шаги</h4>
              <div id="steps-edit" class="space-y-3">
                {% for s in selected_case.steps %}
                  <div class="border rounded p-2">
                    <div class="text-sm text-gray-600 mb-1">#{{ s.position if s.position is not none else loop.index }}</div>
                    <div class="flex gap-2 items-start">
                      <input type="text" name="steps[{{ loop.index0 }}][action]" value="{{ s.action }}" class="flex-1 border rounded text-sm px-2 py-1" placeholder="Action">
                      <input type="text" name="steps[{{ loop.index0 }}][expected]" value="{{ s.expected }}" class="flex-1 border rounded text-sm px-2 py-1" placeholder="Expected">
                      <button type="button" onclick="this.parentElement.parentElement.remove()" class="px-2 py-1 bg-red-500 text-white rounded">−</button>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div class="mt-2">
                <button type="button" onclick="addEditStep()" class="px-2 py-1 bg-green-500 text-white text-sm rounded">+ Шаг</button>
              </div>

              <div class="mb-3">
              <label class="block font-medium">Ожидаемый результат</label>
              <textarea name="expected_result" class="w-full border rounded px-3 py-2" rows="2">{{ selected_case.expected_result }}</textarea>
              </div>
            </div>

            <!-- Дополнительная информация -->
            <div class="mb-3">
              <div class="text-sm text-gray-500">
                Created: {% if selected_case.created_at %}{{ selected_case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}{% endif %}
                {% if selected_case.updated_at %}
                  <br>Updated: {{ selected_case.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% endif %}
              </div>
            </div>

            <div class="mt-4 flex justify-between">
              <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Сохранить изменения</button>

              <form action="{{ url_for('routes.get_test_case', test_case_id=selected_case.id) }}" method="post">
                <input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded">Удалить</button>
              </form>
            </div>
          </form>

          <script>
            (function(){
              let editIndex = {{ selected_case.steps|length }};
              window.addEditStep = function(){
                const container = document.getElementById('steps-edit');
                const div = document.createElement('div');
                div.className = 'border rounded p-2';
                div.innerHTML = `<div class="text-sm text-gray-600 mb-1">#${editIndex + 1}</div>
                  <div class="flex gap-2 items-start">
                    <input type="text" name="steps[${editIndex}][action]" placeholder="Action" class="flex-1 border rounded px-2 py-1">
                    <input type="text" name="steps[${editIndex}][expected]" placeholder="Expected" class="flex-1 border rounded px-2 py-1">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="px-2 py-1 bg-red-500 text-white rounded">−</button>
                  </div>`;
                container.appendChild(div);
                editIndex++;
              };
            })();
          </script>

          <!-- === Вложения — отдельный блок (вне формы update/create) чтобы upload не ломал update === -->
          <div class="mt-6 mb-4">
            <h4 class="font-semibold mb-2">Вложения</h4>

            <form id="upload-form" action="{{ url_for('routes.upload_test_case_attachment', test_case_id=selected_case.id) }}" method="post" enctype="multipart/form-data" class="mb-3">
              <input type="file" name="file" class="block w-full border px-2 py-1 rounded bg-white" />
              <div class="mt-2 flex gap-2">
                <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded">Загрузить вложение</button>
              </div>
            </form>

            <div class="space-y-2">
              {% for a in selected_case.attachments %}
                <div class="flex items-center justify-between border rounded p-2">
                  <div>
                    <div class="font-medium">{{ a.original_filename }}</div>
                    <div class="text-xs text-gray-500">{{ a.size }} bytes • {{ a.content_type }}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    <a href="{{ url_for('routes.get_test_case_attachment', test_case_id=selected_case.id, attachment_id=a.id) }}?download=1"
                       class="px-2 py-1 bg-blue-500 text-white rounded text-xs">Download</a>

                    <form action="{{ url_for('routes.get_test_case_attachment', test_case_id=selected_case.id, attachment_id=a.id) }}" method="post">
                      <input type="hidden" name="_method" value="DELETE">
                      <button type="submit" class="px-2 py-1 bg-red-500 text-white rounded text-xs">Delete</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

        {% else %}
          <div class="text-gray-500">Выберите тест-кейс из списка или создайте новый.</div>
        {% endif %}
      </aside>

    </div>
  </div>
</main>
{% endblock %}
